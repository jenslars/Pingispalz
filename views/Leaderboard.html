<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <title>Welcome Pingispals!</title>
        <link rel="icon" type="image/x-icon" href="images/PingisPalsSmallIcon.png">
        <link href="/styleLeaderboard.css" rel="stylesheet">
        <link href="/navigationSidebar.css" rel="stylesheet" type="text/css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="grid-container" id="blur">
        <nav class="sidenav">
            <div id="logo">
                <p>Pingispals<p class="redDot">.</p></p>
            </div>
            <a id="home" href="/home">Home</a>
            <a id="search" href="#">Search</a>
            <a id="leaderboards" href="#" class="active">Clubs</a>
            <a id="challenges" href="/gameChallenge">Challenges</a>
            <a id="profile" href="/editprofile">Profile</a>
        </nav>
        <nav id="searchfield">
            <form>
                <input type="text" placeholder="Search">
            </form>
        </nav>
        <nav id="leaderboardoptions">
            <div id="leaderboardoptionsbuttons">
                <button type="button" id="addserver" onclick="leaderboardpopup()"></button>
                <button type="button" id="findserver"></button>
            </div>
            <div id="clublinks">
                <ul id="clublinkslist"></ul>
            </div>
        </nav>

        <div class="header"> 
            <h2> Malmo University </h2>
            <h3> Leaderboard </h3>
            <div id="topPlayers">
                <div id="top2"> 
                    </div>
                <div id="top1"> 
                    </div>
                <div id="top3"> 
                    </div>
            </div>
        </div>
        <div id="ranking"> 
            <div class="challengePopup" id="challengePopup"> 

                    <img id="closeButton"src="../exitdiscordwhite.png" onclick="closePopup()">
                    <h3 id="playerName1" class="matchPlayers"></h3>
                    <h2 id="versus"> Vs </h2>
                    <h3 id="playerName2" class="matchPlayers"> </h3>
                    <button onclick="sendChallenge()" id="sendChallenge" id="button" role="button">Challenge</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th id="placement"> Placement </th>
                        <th id="username"> Username </th>
                        <th id="wins"> Wins </th>
                        <th id="winRatio"> WinRate </th>
                        <th id="elo"> Elo </th>
                        <th id="status"> Status </th>
                        <th id="play"> Play </th>
                    </tr>
                </thead>
                <tbody id="leaderboard"></tbody>
            </table>
        </div>
        <script>   
            /*Popup for adding leaderboards*/
            function leaderboardpopup() {
            var leaderboardpopupDiv = document.getElementById('leaderboardpopup');
            var gridcontainerLink = document.getElementById('blur');
            leaderboardpopupDiv.classList.add('active');
            gridcontainerLink.classList.add('active');
            }
    
            function exitpopup() {
            var leaderboardpopupDiv = document.getElementById('leaderboardpopup');
            var gridcontainerLink = document.getElementById('blur');
            leaderboardpopupDiv.classList.remove('active');
            gridcontainerLink.classList.remove('active');   
            }
    
    
            /* desktop navbar function */
            var homeLink = document.getElementById('home');
            var searchLink = document.getElementById('search');
            var leaderboardsLink = document.getElementById('leaderboards');
            var challengesLink = document.getElementById('challenges');
            var profileLink = document.getElementById('profile');
            var searchfieldLink = document.getElementById('searchfield');
            var leaderboardoptionsLink = document.getElementById('leaderboardoptions');
    
            homeLink.addEventListener('click', function() {
            homeLink.classList.add('active');
    
            searchLink.classList.remove('active');
            searchfieldLink.classList.remove('active');
            leaderboardsLink.classList.remove('active');
            leaderboardoptionsLink.classList.remove('active');
            challengesLink.classList.remove('active');
            profileLink.classList.remove('active');
            });
    
            searchLink.addEventListener('click', function() {
            searchLink.classList.add('active');
            searchfieldLink.classList.add('active');
            
            homeLink.classList.remove('active');
            leaderboardsLink.classList.remove('active');
            leaderboardoptionsLink.classList.remove('active');
            challengesLink.classList.remove('active');
            profileLink.classList.remove('active');
            });
    
            leaderboardsLink.addEventListener('click', function() {
            leaderboardsLink.classList.add('active');
            leaderboardoptionsLink.classList.add('active');
    
            homeLink.classList.remove('active');
            searchLink.classList.remove('active');
            searchfieldLink.classList.remove('active');
            challengesLink.classList.remove('active');
            profileLink.classList.remove('active');
            });
    
            challengesLink.addEventListener('click', function() {
            challengesLink.classList.add('active');
            
            homeLink.classList.remove('active');
            searchLink.classList.remove('active');
            searchfieldLink.classList.remove('active');
            leaderboardsLink.classList.remove('active');
            leaderboardoptionsLink.classList.remove('active');
            profileLink.classList.remove('active');
            });
    
            profileLink.addEventListener('click', function() {
            profileLink.classList.add('active');
            homeLink.classList.remove('active');
            searchLink.classList.remove('active');
            searchfieldLink.classList.remove('active');
            leaderboardsLink.classList.remove('active');
            leaderboardoptionsLink.classList.remove('active');
            challengesLink.classList.remove('active');
            });
        </script>
        <script>
            //Laddar in användare från databas in i leaderboarden
            let playerData;
            function testLoadLeaderboard() {
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/leaderboard/score")
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send();
                xhr.onreadystatechange = function() {
                    console.log('hello world')
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const response = xhr.response
                            players = JSON.parse(response);
                            assignPlacements(playerData);
                            console.log(xhr)
                            const ladder = document.getElementById('leaderboard');
                            ladder.innerHTML = '';
                            players.forEach(player => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${player.placement}</td>
                                <td><a href="/viewProfile/${player.user_id}">${player.username}</a></td>
                                <td>${player.wins}</td>
                                <td>${player.winratio}</td>
                                <td>${player.elo}</td>
                                <td>${player.status}</td>
                                <td><button class="challengebutton" onclick="openPopup('${player.username}','${player.user_id}')">Challenge</button></td>
                            `;
                            if (player.losses || player.wins) {
                                let winLossRatio;
                                if (player.losses) {
                                    winLossRatio = ((player.wins / (player.wins + player.losses)) * 100).toFixed(0) + "%";
                                } else {
                                    winLossRatio = "100%";
                                }
                                row.children[3].textContent = winLossRatio;

                            }
                            else {
                                row.children[3].textContent = "n/a";
                            }
                            ladder.appendChild(row);
                            });
                } else {
                }
                }
            };
            }
            testLoadLeaderboard()
            //Visar upp top 3 spelare i leaderboarden
                function topPlayers(playerData) {
                const top1 = players.find(player => player.placement === "1");
                const top2 = players.find(player => player.placement === "2");
                const top3 = players.find(player => player.placement === "3");

                const top1Div = `
                    <img class="crown" src="/Crown.png">
                    <img class="playerProfilePhoto" src="/mightyloaf.png">
                    <p>${top1.username}</p>
                    <p>#${top1.placement}</p>
                `;

                const top2Div = `
                    <img class="playerProfilePhoto" src="/akwardcat.jpg">
                    <p>${top2.username}</p>
                    <p>#${top2.placement}</p>
                `;

                const top3Div = `
                    <img class="playerProfilePhoto" src="/akwardcat.jpg">
                    <p>${top3.username}</p>
                    <p>#${top3.placement}</p>
                `;

                document.getElementById("top1").innerHTML = top1Div;
                document.getElementById("top2").innerHTML = top2Div;
                document.getElementById("top3").innerHTML = top3Div;
            }

            function loadLeaderboard() {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", "/leaderboard/score");
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.send();

                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        const response = JSON.parse(xhr.response);
                        topPlayers(response);
                    }
                };
            }

            loadLeaderboard();
function assignPlacements(playerData) {
  for (let i = 0; i < players.length; i++) {
    if (i === 0) {
      players[i].placement = "1";
    } else if (i === 1) {
      players[i].placement = "2";
    } else if (i === 2) {
      players[i].placement = "3";
    } else {
      players[i].placement = (i + 1).toString();
    }
  }
}


// sorts players in the leaderboard by wins
const winsHeader = document.getElementById('wins');
function sortPlayersByWins(players) {
    players.sort((a, b) => b.wins - a.wins);
    updateLeaderboard(players);
}
winsHeader.addEventListener("click", function() {
sortPlayersByWins(players);
})
//sorts players in the leaderboard by placement
const placement = document.getElementById('placement');
function sortPlayersByPlacement(players) {
    players.sort((a, b) => a.placement - b.placement);
    updateLeaderboard(players);
}
placement.addEventListener("click", function() {
    sortPlayersByPlacement(players);    
})
//sorts players in the leaderboard by winrate funkar inte
const winRateHeader = document.getElementById('winRatio')
function sortPlayersByWinrate(players) {
    players.sort((a, b) => b.winratio - a.winratio);
    updateLeaderboard(players);
}
winRateHeader.addEventListener("click", function() {
    sortPlayersByWinrate(players);
})
//Updates leaderboard with new placements
function updateLeaderboard(players) {
  const ladder = document.getElementById('leaderboard');
  ladder.innerHTML = '';
  players.forEach(player => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${player.placement}</td>
      <td><a href="/player/${player.user_id}">${player.username}</a></td>
      <td>${player.wins}</td>
      <td>${player.winratio}</td>
      <td>${player.elo}</td>
      <td>${player.status}</td>
      <td><button>Play</button></td>
    `;
    if (player.losses || player.wins) {
        let winLossRatio;
        if (player.losses) {
            winLossRatio = ((player.wins / (player.wins + player.losses)) * 100).toFixed(0) + "%";
        } else {
            winLossRatio = "100%";
        }
        row.children[3].textContent = winLossRatio;

    }
    else {
        row.children[3].textContent = "n/a";
    }
    ladder.appendChild(row);
  });
}
            let popup = document.getElementById("challengePopup");
            let challengedPlayerId; 
            function openPopup(player, playerId){
                fetch('/challenge/player')
                    .then(response => response.json())
                    .then(data => {
                        // Update the HTML elements with the fetched data
                        document.getElementById('playerName1').textContent = data.queryUser;
                    })
                    .catch(error => console.error(error));

                challengePopup.classList.add("show-challengePopup");
                challengedPlayer = player;
                challengedPlayerId = playerId;
                document.getElementById("playerName2").innerHTML = player;

            }
            function closePopup(){
                challengePopup.classList.remove("show-challengePopup");
            }
            function sendChallenge(){
                console.log(challengedPlayerId);
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/sendChallengeFromLeaderboard", true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        // document.getElementById("error-message").innerHTML = "Good";
                        // window.location.href = "/home";
                    } else {
                        // document.getElementById("error-message").innerHTML = "Bad";
                    }
                } else {
                    // document.getElementById("error-message").innerHTML = "Something went wrong";
                }
            };
            xhr.send(JSON.stringify({
                recipientId : challengedPlayerId
            }));
            }
        </script> 

        
    </div>
    
</body>

</html>

        